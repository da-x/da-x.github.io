<!DOCTYPE html>
<html lang="en-US">
<head>


 <!-- Global site tag (gtag.js) - Google Analytics -->
 <script async src="https://www.googletagmanager.com/gtag/js?id=UA-35403825-1"></script>
 <script>
   window.dataLayer = window.dataLayer || [];
   function gtag(){dataLayer.push(arguments);}
   gtag('js', new Date());

    gtag('config', 'UA-35403825-1');
 </script>


<meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="preload" as="font" href="https://blog.aloni.org/fonts/vendor/jost/jost-v4-latin-regular.woff2" type="font/woff2" crossorigin>
  <link rel="preload" as="font" href="https://blog.aloni.org/fonts/vendor/jost/jost-v4-latin-700.woff2"  type="font/woff2" crossorigin>


<link rel="stylesheet" href="https://blog.aloni.org/main.css">



  
  
  
  
  
    
  

  
  
    
    
  
  
  
    
  
  
  
  
    
  
  
  


  <meta name="robots" content="index, follow">
  <meta name="googlebot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">
  <meta name="bingbot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">


	


	

<title>Computing Symbolic Gradient Vectors with Plain Haskell | Dan Aloni</title>
<meta name="description" content="Dan Aloni">
<link rel="canonical" href="https://blog.aloni.org/posts/symbolic-gradients-with-plain-haskell/">










<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BreadcrumbList",
    
      
      
        
        
        
        
        
        
        
        
          {
            "@type": "ListItem",
            "position":  1 ,
            "name": "Home",
            "item": "https://blog.aloni.org/"
          },
          
          
          {
            "@type": "ListItem",
            "position":  2 ,
            "name": "Posts",
            "item": "https://blog.aloni.org/posts/"
          },
        
      
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
          
          
          {
            "@type": "ListItem",
            "position":  3 ,
            "name": "Symbolic Gradients With Plain Haskell",
            "item": "https://blog.aloni.org/posts/symbolic-gradients-with-plain-haskell/"
          },
        
      
    
  }
</script>





  <meta name="theme-color" content="#fff">
  <link rel="apple-touch-icon" sizes="180x180" href="https://blog.aloni.org/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://blog.aloni.org/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://blog.aloni.org/favicon-16x16.png">
  
    <link rel="manifest" href="https://blog.aloni.org/site.webmanifest">
  


  
    
      <!-- KaTeX -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
      <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
      <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
    
  

</head>

  


<body class="blog single">
  
  
<div class="header-bar fixed-top"></div>
<header class="navbar fixed-top navbar-expand-md navbar-light">
	<div class="container">
		<input class="menu-btn order-0" type="checkbox" id="menu-btn">
		<label class="menu-icon d-md-none" for="menu-btn"><span class="navicon"></span></label>
		<a class="navbar-brand order-1 order-md-0 me-auto" href="https://blog.aloni.org">Dan Aloni</a>
		<button id="mode" class="btn btn-link order-2 order-md-4" type="button" aria-label="Toggle mode">
			<span class="toggle-dark"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></span>
			<span class="toggle-light"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg></span>
		</button>
		<button id="code-mode" class="btn btn-link order-2 order-md-4" type="button" aria-label="Toggle mode">
			<span class="code-toggle-dark"><svg xmlns="http://www.w3.org/2000/svg" width="26" height="30" viewBox="-2 0 28 36" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
			    <text x="-2" y="34" font-size="10" stroke-width="1" font-family="Jose" font-weight="100">CODE</text>
  		        </svg></span>
			<span class="code-toggle-light"><svg xmlns="http://www.w3.org/2000/svg" width="26" height="30" viewBox="-2 0 28 36" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
			    <text x="-2" y="34" font-size="10" stroke-width="1" font-family="Jose" font-weight="100">CODE</text>
			</svg></span>
		</button>
		<ul class="navbar-nav fork-me order-3 order-md-5">
			
				
					<li class="nav-item">
						<a class="nav-link" href="/atom.xml"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-rss" viewBox="0 0 16 16"> <path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/> <path d="M5.5 12a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm-3-8.5a1 1 0 0 1 1-1c5.523 0 10 4.477 10 10a1 1 0 1 1-2 0 8 8 0 0 0-8-8 1 1 0 0 1-1-1zm0 4a1 1 0 0 1 1-1 6 6 0 0 1 6 6 1 1 0 1 1-2 0 4 4 0 0 0-4-4 1 1 0 0 1-1-1z"/> </svg><span class="ms-2 visually-hidden">RSS</span></a>
					</li>
				
					<li class="nav-item">
						<a class="nav-link" href="https://twitter.com/DanAloni"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-twitter"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg><span class="ms-2 visually-hidden">Twitter</span></a>
					</li>
				
					<li class="nav-item">
						<a class="nav-link" href="https://github.com/da-x"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg><span class="ms-2 visually-hidden">GitHub</span></a>
					</li>
				
			
		</ul>
		<div class="collapse navbar-collapse order-4 order-md-1">
			<ul class="navbar-nav main-nav me-auto order-5 order-md-2">
				
					
						<li class="nav-item">
							<a class="nav-link" href="https://blog.aloni.org/pages/about/intro/">Pages</a>
						</li>
					
						<li class="nav-item">
							<a class="nav-link" href="https://blog.aloni.org/posts/">Recent</a>
						</li>
					
						<li class="nav-item">
							<a class="nav-link" href="https://blog.aloni.org/archive/">Archive</a>
						</li>
					

				
			</ul>
			<div class="break order-6 d-md-none"></div>
			
		</div>
	</div>
</header>



  
<div class="wrap container" role="document">
  <div class="content">
    <div class="row justify-content-center">
      <div class="col-md-14 col-lg-12 col-xl-10">
        <article>
          <div class="blog-header">
            <h1>Computing Symbolic Gradient Vectors with Plain Haskell</h1>
            
<p><small>Posted April 27, 2016&nbsp;&hyphen;&nbsp;<strong>5&nbsp;min read</strong></small><p>

          </div>
          
          <p>While writing my <a href="/posts/backprop-with-tensorflow">previous post</a>, I was curious how easy it would be to implement <span class='external-link-outer'><a class="external-link"rel="noopener" target="_blank" href="https://www.tensorflow.org">TensorFlow<span class='external-link-no-underline'></span><svg width='13.5' height='13.5' aria-hidden='true' viewBox='0 0 24 24' class='iconExternalLink_wgqa'><path fill='currentColor' d='M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z'></path></svg></a></span>'s automatic differentiation for back propagation. In TensorFlow's web site they call it 'automatic differentiation' but in fact they probably do 'symbolic differentiation', as <span class='external-link-outer'><a class="external-link"rel="noopener" target="_blank" href="http://download.tensorflow.org/paper/whitepaper2015.pdf">mentioned in their white paper<span class='external-link-no-underline'></span><svg width='13.5' height='13.5' aria-hidden='true' viewBox='0 0 24 24' class='iconExternalLink_wgqa'><path fill='currentColor' d='M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z'></path></svg></a></span>. The difference between the two relates to whether the differentiation is done during the original computation or beforehand. It makes sense to do the latter, because then you can maintain a separate computational graph of the back propagation to perform the updates.</p>
<span id="continue-reading"></span>
<p>I've looked into this topic in the <span class='external-link-outer'><a class="external-link"rel="noopener" target="_blank" href="https://en.wikipedia.org/wiki/Haskell_(programming_language)">Haskell<span class='external-link-no-underline'></span><svg width='13.5' height='13.5' aria-hidden='true' viewBox='0 0 24 24' class='iconExternalLink_wgqa'><path fill='currentColor' d='M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z'></path></svg></a></span> ecosystem, and found many useful and extensive libraries, namely <span class='external-link-outer'><a class="external-link"rel="noopener" target="_blank" href="https://hackage.haskell.org/package/ad">ad<span class='external-link-no-underline'></span><svg width='13.5' height='13.5' aria-hidden='true' viewBox='0 0 24 24' class='iconExternalLink_wgqa'><path fill='currentColor' d='M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z'></path></svg></a></span> by Edward Kmett. However, to use these libraries or understand many of the blog posts on the subject requires some advanced Haskell, and I was wondering whether one can get going with differentiation using very basic and lean use of Haskell.</p>
<p><em>So, how easy it would be to compute gradients of single-output functions, using Haskell with only the basic arsenal at our hands?</em></p>
<h2 id="data-and-imports">Data and imports</h2>
<p>First, we perform some imports and declare the basic data type to hold our expression tree:</p>
<div class="mycode-block"><table class="codeBox"><tbody><tr><td class="sourceCode sourceCodeWrap"><pre class="code"><span class="source haskell"><span class="meta import haskell"><span class="keyword other haskell">import</span>           <span class="support other module haskell">Control.Monad</span> <span class="meta declaration exports haskell">(<span class="entity name function haskell">forM_</span>)</span></span>
<span class="meta import haskell"><span class="keyword other haskell">import</span> <span class="keyword other haskell">qualified</span> <span class="support other module haskell">Data.Map</span>      <span class="keyword other haskell">as</span> <span class="support other module haskell">Map</span></span>

<span class="keyword other haskell">data</span> <span class="constant other haskell">Expr</span>
   <span class="keyword operator haskell">=</span> <span class="constant other haskell">Term</span> <span class="constant other haskell">Int</span>       <span class="comment line double-dash haskell"><span class="punctuation definition comment haskell">--</span> &#39;Term 0&#39; is x0, &#39;Term 1&#39; is x1, etc..
</span>   <span class="keyword operator haskell">|</span> <span class="constant other haskell">Lit</span> <span class="constant other haskell">Float</span>      <span class="comment line double-dash haskell"><span class="punctuation definition comment haskell">--</span> Constant numbers
</span>   <span class="keyword operator haskell">|</span> <span class="constant other haskell">Neg</span> <span class="constant other haskell">Expr</span>       <span class="comment line double-dash haskell"><span class="punctuation definition comment haskell">--</span> -f
</span>   <span class="keyword operator haskell">|</span> <span class="constant other haskell">Mul</span> <span class="constant other haskell">Expr</span> <span class="constant other haskell">Expr</span>  <span class="comment line double-dash haskell"><span class="punctuation definition comment haskell">--</span> a + b
</span>   <span class="keyword operator haskell">|</span> <span class="constant other haskell">Add</span> <span class="constant other haskell">Expr</span> <span class="constant other haskell">Expr</span>  <span class="comment line double-dash haskell"><span class="punctuation definition comment haskell">--</span> a * b
</span>   <span class="keyword operator haskell">|</span> <span class="constant other haskell">Sin</span> <span class="constant other haskell">Expr</span>       <span class="comment line double-dash haskell"><span class="punctuation definition comment haskell">--</span> sin a
</span>   <span class="keyword operator haskell">|</span> <span class="constant other haskell">Cos</span> <span class="constant other haskell">Expr</span>       <span class="comment line double-dash haskell"><span class="punctuation definition comment haskell">--</span> cos a
</span>   <span class="meta deriving haskell"><span class="keyword other haskell">deriving</span> (<span class="entity other inherited-class haskell">Show</span>, <span class="entity other inherited-class haskell">Eq</span>, <span class="entity other inherited-class haskell">Ord</span>)</span>
</span></td></pre></tr></tbody></table></div>
<p>We shall be able to derive symbolic gradients for any function built with this data type.</p>
<h2 id="poor-man-s-pretty-printing">Poor man's pretty-printing</h2>
<p>One cannot go by without a nice String representation:</p>
<div class="mycode-block"><table class="codeBox"><tbody><tr><td class="sourceCode sourceCodeWrap"><pre class="code"><span class="source haskell"><span class="meta function type-declaration haskell"><span class="entity name function haskell">fshow</span> <span class="keyword other double-colon haskell">::</span> <span class="storage type haskell">Expr</span> <span class="keyword other arrow haskell">-&gt;</span> <span class="storage type haskell">String</span>
</span>fshow (<span class="constant other haskell">Term</span> v)    <span class="keyword operator haskell">=</span> concat [<span class="string quoted double haskell"><span class="punctuation definition string begin haskell">&quot;</span>x<span class="punctuation definition string end haskell">&quot;</span></span><span class="punctuation separator comma haskell">,</span> show v]
fshow (<span class="constant other haskell">Lit</span> v)     <span class="keyword operator haskell">=</span> show v
fshow (<span class="constant other haskell">Mul</span> e1 e2) <span class="keyword operator haskell">=</span> concat [<span class="string quoted double haskell"><span class="punctuation definition string begin haskell">&quot;</span>(<span class="punctuation definition string end haskell">&quot;</span></span><span class="punctuation separator comma haskell">,</span> fshow e1<span class="punctuation separator comma haskell">,</span> <span class="string quoted double haskell"><span class="punctuation definition string begin haskell">&quot;</span> * <span class="punctuation definition string end haskell">&quot;</span></span><span class="punctuation separator comma haskell">,</span> fshow e2<span class="punctuation separator comma haskell">,</span> <span class="string quoted double haskell"><span class="punctuation definition string begin haskell">&quot;</span>)<span class="punctuation definition string end haskell">&quot;</span></span>]
fshow (<span class="constant other haskell">Add</span> e1 e2) <span class="keyword operator haskell">=</span> concat [<span class="string quoted double haskell"><span class="punctuation definition string begin haskell">&quot;</span>(<span class="punctuation definition string end haskell">&quot;</span></span><span class="punctuation separator comma haskell">,</span> fshow e1<span class="punctuation separator comma haskell">,</span> <span class="string quoted double haskell"><span class="punctuation definition string begin haskell">&quot;</span> + <span class="punctuation definition string end haskell">&quot;</span></span><span class="punctuation separator comma haskell">,</span> fshow e2<span class="punctuation separator comma haskell">,</span> <span class="string quoted double haskell"><span class="punctuation definition string begin haskell">&quot;</span>)<span class="punctuation definition string end haskell">&quot;</span></span>]
fshow (<span class="constant other haskell">Neg</span> e)     <span class="keyword operator haskell">=</span> concat [<span class="string quoted double haskell"><span class="punctuation definition string begin haskell">&quot;</span>-(<span class="punctuation definition string end haskell">&quot;</span></span><span class="punctuation separator comma haskell">,</span> fshow e<span class="punctuation separator comma haskell">,</span> <span class="string quoted double haskell"><span class="punctuation definition string begin haskell">&quot;</span>)<span class="punctuation definition string end haskell">&quot;</span></span>]
fshow (<span class="constant other haskell">Sin</span> e)     <span class="keyword operator haskell">=</span> concat [<span class="string quoted double haskell"><span class="punctuation definition string begin haskell">&quot;</span>sin(<span class="punctuation definition string end haskell">&quot;</span></span><span class="punctuation separator comma haskell">,</span> fshow e<span class="punctuation separator comma haskell">,</span> <span class="string quoted double haskell"><span class="punctuation definition string begin haskell">&quot;</span>)<span class="punctuation definition string end haskell">&quot;</span></span>]
fshow (<span class="constant other haskell">Cos</span> e)     <span class="keyword operator haskell">=</span> concat [<span class="string quoted double haskell"><span class="punctuation definition string begin haskell">&quot;</span>cos(<span class="punctuation definition string end haskell">&quot;</span></span><span class="punctuation separator comma haskell">,</span> fshow e<span class="punctuation separator comma haskell">,</span> <span class="string quoted double haskell"><span class="punctuation definition string begin haskell">&quot;</span>)<span class="punctuation definition string end haskell">&quot;</span></span>]
</span></td></pre></tr></tbody></table></div>
<p>This implementation is basic in so that a sequence of summations will bear a horrible representation similar to <code>(x1 + (x2 + (x3 + (...))))</code> - however it's enough to get us going.</p>
<h2 id="sample">Sample</h2>
<p>The <span class='external-link-outer'><a class="external-link"rel="noopener" target="_blank" href="https://en.wikipedia.org/wiki/Automatic_differentiation">Wikipedia page for Automatic Differentiation<span class='external-link-no-underline'></span><svg width='13.5' height='13.5' aria-hidden='true' viewBox='0 0 24 24' class='iconExternalLink_wgqa'><path fill='currentColor' d='M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z'></path></svg></a></span> demonstrates with the following function:</p>
<p>$$
f(x_1, x_2) = \sin x_1 + x_1x_2
$$</p>
<p>It should be easy enough to represent it with our Haskell data, and use <code>fshow</code> from above:</p>
<div class="mycode-block"><table class="codeBox"><tbody><tr><td class="sourceCode sourceCodeWrap"><pre class="code"><span class="source haskell">λ<span class="keyword operator haskell">&gt;</span> <span class="keyword other haskell">let</span> wikipediaFunc <span class="keyword operator haskell">=</span> (<span class="constant other haskell">Sin</span> (<span class="constant other haskell">Term</span> <span class="constant numeric integer decimal haskell">1</span>)) <span class="keyword operator function infix haskell"><span class="punctuation definition entity haskell">`</span>Add<span class="punctuation definition entity haskell">`</span></span> ((<span class="constant other haskell">Term</span> <span class="constant numeric integer decimal haskell">1</span>) <span class="keyword operator function infix haskell"><span class="punctuation definition entity haskell">`</span>Mul<span class="punctuation definition entity haskell">`</span></span> (<span class="constant other haskell">Term</span> <span class="constant numeric integer decimal haskell">2</span>))

λ<span class="keyword operator haskell">&gt;</span> fshow wikipediaFunc
<span class="string quoted double haskell"><span class="punctuation definition string begin haskell">&quot;</span>(sin(x1) + (x1 * x2))<span class="punctuation definition string end haskell">&quot;</span></span>
</span></td></pre></tr></tbody></table></div><h2 id="gradient">Gradient</h2>
<p>The <code>gradient</code> function below takes an expression, and returns a map from each term number to the expression that computes it. The definition of the function is recursive and based on known simple derivation rules:</p>
<div class="mycode-block"><table class="codeBox"><tbody><tr><td class="sourceCode sourceCodeWrap"><pre class="code"><span class="source haskell"><span class="meta function type-declaration haskell"><span class="entity name function haskell">gradient</span> <span class="keyword other double-colon haskell">::</span> <span class="storage type haskell">Expr</span> <span class="keyword other arrow haskell">-&gt;</span> <span class="storage type haskell">Map</span>.<span class="storage type haskell">Map</span> <span class="storage type haskell">Int</span> <span class="storage type haskell">Expr</span>
</span>gradient (<span class="constant other haskell">Neg</span> e)     <span class="keyword operator haskell">=</span> <span class="constant other haskell">Map</span><span class="keyword operator haskell">.</span>map <span class="constant other haskell">Neg</span> (gradient e)
gradient (<span class="constant other haskell">Cos</span> e)     <span class="keyword operator haskell">=</span> <span class="constant other haskell">Map</span><span class="keyword operator haskell">.</span>map (<span class="constant other haskell">Mul</span> (<span class="constant other haskell">Neg</span> (<span class="constant other haskell">Sin</span> e))) (gradient e)
gradient (<span class="constant other haskell">Sin</span> e)     <span class="keyword operator haskell">=</span> <span class="constant other haskell">Map</span><span class="keyword operator haskell">.</span>map (<span class="constant other haskell">Mul</span> (<span class="constant other haskell">Cos</span> e)) (gradient e)
gradient (<span class="constant other haskell">Term</span> i)    <span class="keyword operator haskell">=</span> <span class="constant other haskell">Map</span><span class="keyword operator haskell">.</span>fromList [(i<span class="punctuation separator comma haskell">,</span> <span class="constant other haskell">Lit</span> <span class="constant numeric float decimal haskell">1<span class="punctuation separator decimal haskell">.</span>0</span>)]
gradient (<span class="constant other haskell">Lit</span> _)     <span class="keyword operator haskell">=</span> <span class="constant other haskell">Map</span><span class="keyword operator haskell">.</span>empty
gradient (<span class="constant other haskell">Add</span> e1 e2) <span class="keyword operator haskell">=</span> <span class="constant other haskell">Map</span><span class="keyword operator haskell">.</span>unionWith <span class="constant other haskell">Add</span> (gradient e1) (gradient e2)
gradient (<span class="constant other haskell">Mul</span> e1 e2) <span class="keyword operator haskell">=</span> <span class="constant other haskell">Map</span><span class="keyword operator haskell">.</span>unionWith <span class="constant other haskell">Add</span> (<span class="constant other haskell">Map</span><span class="keyword operator haskell">.</span>map (<span class="constant other haskell">Mul</span> e2) (gradient e1))
                                         (<span class="constant other haskell">Map</span><span class="keyword operator haskell">.</span>map (<span class="constant other haskell">Mul</span> e1) (gradient e2))
</span></td></pre></tr></tbody></table></div>
<p>The interesting parts are where <code>Map.unionWith</code> is used for addition and multiplication. Notice how easily the <code>Mul</code> part relates to the known derivation rule:</p>
<p>$$(f(x)g(x))' = g(x)f'(x) + g'(x)f(x)$$</p>
<p>The documentation for <span class='external-link-outer'><a class="external-link"rel="noopener" target="_blank" href="https://hackage.haskell.org/package/containers/docs/Data-Map-Strict.html">Data.Map<span class='external-link-no-underline'></span><svg width='13.5' height='13.5' aria-hidden='true' viewBox='0 0 24 24' class='iconExternalLink_wgqa'><path fill='currentColor' d='M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z'></path></svg></a></span> can tell about <code>Map.map</code> and <code>Map.unionWith</code>.</p>
<h2 id="small-helpers">Small helpers</h2>
<p>Before testing it, we'll add just two helper functions. The first function simplifies expressions by getting rid of the $1.0$ literals we have added.</p>
<div class="mycode-block"><table class="codeBox"><tbody><tr><td class="sourceCode sourceCodeWrap"><pre class="code"><span class="source haskell"><span class="meta function type-declaration haskell"><span class="entity name function haskell">simplify</span> <span class="keyword other double-colon haskell">::</span> <span class="storage type haskell">Expr</span> <span class="keyword other arrow haskell">-&gt;</span> <span class="storage type haskell">Expr</span>
</span>simplify (<span class="constant other haskell">Mul</span> (<span class="constant other haskell">Lit</span> <span class="constant numeric float decimal haskell">1<span class="punctuation separator decimal haskell">.</span>0</span>) e) <span class="keyword operator haskell">=</span> simplify e
simplify (<span class="constant other haskell">Mul</span> e (<span class="constant other haskell">Lit</span> <span class="constant numeric float decimal haskell">1<span class="punctuation separator decimal haskell">.</span>0</span>)) <span class="keyword operator haskell">=</span> simplify e
simplify (<span class="constant other haskell">Add</span> e1 e2) <span class="keyword operator haskell">=</span> <span class="constant other haskell">Add</span> (simplify e1) (simplify e2)
simplify (<span class="constant other haskell">Mul</span> e1 e2) <span class="keyword operator haskell">=</span> <span class="constant other haskell">Mul</span> (simplify e1) (simplify e2)
simplify e <span class="keyword operator haskell">=</span> e
</span></td></pre></tr></tbody></table></div>
<p>The second function will do all the work at the program's top level to compute the gradient and print it:</p>
<div class="mycode-block"><table class="codeBox"><tbody><tr><td class="sourceCode sourceCodeWrap"><pre class="code"><span class="source haskell"><span class="meta function type-declaration haskell"><span class="entity name function haskell">showGradient</span> <span class="keyword other double-colon haskell">::</span> <span class="storage type haskell">Expr</span> <span class="keyword other arrow haskell">-&gt;</span> <span class="storage type haskell">IO</span> <span class="support constant unit haskell">()</span>
</span>showGradient func <span class="keyword operator haskell">=</span> <span class="keyword control haskell">do</span>
    putStrLn <span class="keyword operator haskell">$</span> <span class="string quoted double haskell"><span class="punctuation definition string begin haskell">&quot;</span>f(..) = <span class="punctuation definition string end haskell">&quot;</span></span> <span class="keyword operator haskell">++</span> fshow func

    forM_ (<span class="constant other haskell">Map</span><span class="keyword operator haskell">.</span>toList <span class="keyword operator haskell">$</span> gradient func) <span class="keyword operator haskell">$</span> <span class="keyword operator haskell">\</span>(k<span class="punctuation separator comma haskell">,</span> v) <span class="keyword operator haskell">-&gt;</span> <span class="keyword control haskell">do</span>
        putStrLn <span class="keyword operator haskell">$</span> <span class="string quoted double haskell"><span class="punctuation definition string begin haskell">&quot;</span>∂f / ∂<span class="punctuation definition string end haskell">&quot;</span></span> <span class="keyword operator haskell">++</span> fshow (<span class="constant other haskell">Term</span> k) <span class="keyword operator haskell">++</span> <span class="string quoted double haskell"><span class="punctuation definition string begin haskell">&quot;</span> = <span class="punctuation definition string end haskell">&quot;</span></span> <span class="keyword operator haskell">++</span> (fshow <span class="keyword operator haskell">.</span> simplify) v
</span></td></pre></tr></tbody></table></div><h2 id="does-it-work">Does it work?</h2>
<div class="mycode-block"><table class="codeBox"><tbody><tr><td class="sourceCode sourceCodeWrap"><pre class="code"><span class="source haskell"><span class="keyword operator haskell">&gt;</span> showGradient wikipediaFunc

f<span class="entity name function infix haskell">(..)</span> <span class="keyword operator haskell">=</span> (sin(x1) <span class="keyword operator haskell">+</span> (x1 * x2))
∂f <span class="keyword operator haskell">/</span> ∂x1 <span class="keyword operator haskell">=</span> (cos(x1) <span class="keyword operator haskell">+</span> x2)
∂f <span class="keyword operator haskell">/</span> ∂x2 <span class="keyword operator haskell">=</span> x1
</span></td></pre></tr></tbody></table></div>
<p>Looks that it does. We have arrived at the same results as Wikipedia.</p>
<script type="math/tex;mode=display">\begin{aligned}
& \frac{∂ f}{∂ x_1} = \cos x_1 + x_2 \\
& \frac{∂ f}{∂ x_2} = x_1 \\
\end{aligned}</script>
<p>Will it work with something more complex?</p>
<div class="mycode-block"><table class="codeBox"><tbody><tr><td class="sourceCode sourceCodeWrap"><pre class="code"><span class="source haskell"><span class="keyword operator haskell">&gt;</span> showGradient (<span class="constant other haskell">Sin</span> (<span class="constant other haskell">Mul</span> (<span class="constant other haskell">Term</span> <span class="constant numeric integer decimal haskell">2</span> <span class="keyword operator function infix haskell"><span class="punctuation definition entity haskell">`</span>Add<span class="punctuation definition entity haskell">`</span></span> <span class="constant other haskell">Lit</span> <span class="constant numeric float decimal haskell">5<span class="punctuation separator decimal haskell">.</span>1</span>) <span class="keyword operator haskell">$</span> <span class="constant other haskell">Cos</span> (<span class="constant other haskell">Term</span> <span class="constant numeric integer decimal haskell">1</span>))) <span class="keyword operator function infix haskell"><span class="punctuation definition entity haskell">`</span>Mul<span class="punctuation definition entity haskell">`</span></span> (<span class="constant other haskell">Term</span> <span class="constant numeric integer decimal haskell">1</span>) <span class="keyword operator function infix haskell"><span class="punctuation definition entity haskell">`</span>Mul<span class="punctuation definition entity haskell">`</span></span> (<span class="constant other haskell">Term</span> <span class="constant numeric integer decimal haskell">3</span>)

f<span class="entity name function infix haskell">(..)</span> <span class="keyword operator haskell">=</span> ((sin(((x2 <span class="keyword operator haskell">+</span> <span class="constant numeric float decimal haskell">5<span class="punctuation separator decimal haskell">.</span>1</span>) * cos(x1))) * x1) * x3)
∂f <span class="keyword operator haskell">/</span> ∂x1 <span class="keyword operator haskell">=</span> (x3 * ((x1 * (cos(((x2 <span class="keyword operator haskell">+</span> <span class="constant numeric float decimal haskell">5<span class="punctuation separator decimal haskell">.</span>1</span>) * cos(x1))) * ((x2 <span class="keyword operator haskell">+</span> <span class="constant numeric float decimal haskell">5<span class="punctuation separator decimal haskell">.</span>1</span>) * <span class="keyword operator haskell">-</span>(sin(x1))))) <span class="keyword operator haskell">+</span> sin(((x2 <span class="keyword operator haskell">+</span> <span class="constant numeric float decimal haskell">5<span class="punctuation separator decimal haskell">.</span>1</span>) * cos(x1)))))
∂f <span class="keyword operator haskell">/</span> ∂x2 <span class="keyword operator haskell">=</span> (x3 * (x1 * (cos(((x2 <span class="keyword operator haskell">+</span> <span class="constant numeric float decimal haskell">5<span class="punctuation separator decimal haskell">.</span>1</span>) * cos(x1))) * cos(x1))))
∂f <span class="keyword operator haskell">/</span> ∂x3 <span class="keyword operator haskell">=</span> (sin(((x2 <span class="keyword operator haskell">+</span> <span class="constant numeric float decimal haskell">5<span class="punctuation separator decimal haskell">.</span>1</span>) * cos(x1))) * x1)
</span></td></pre></tr></tbody></table></div>
<p>Comparing with <span class='external-link-outer'><a class="external-link"rel="noopener" target="_blank" href="https://www.wolframalpha.com/input/?i=derive+((sin(((x2+%2B+5.1)+*+cos(x1)))+*+x1)+*+x3)">Wolfram Alpha<span class='external-link-no-underline'></span><svg width='13.5' height='13.5' aria-hidden='true' viewBox='0 0 24 24' class='iconExternalLink_wgqa'><path fill='currentColor' d='M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z'></path></svg></a></span>, it seems to get it right.</p>
<h2 id="end-note">End note</h2>
<p>Advance extensions of what I illustrated here can add a considerable amount of functionality and ease of use. We will definitely need to support matrices for instance, if we would like to derive a back-propagation graph. You can browse the <span class='external-link-outer'><a class="external-link"rel="noopener" target="_blank" href="https://hackage.haskell.org/package/ad">ad<span class='external-link-no-underline'></span><svg width='13.5' height='13.5' aria-hidden='true' viewBox='0 0 24 24' class='iconExternalLink_wgqa'><path fill='currentColor' d='M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z'></path></svg></a></span> package to get some ideas.</p>

        </article>
	<div>
	    <hr />
	    <div class="footerIcons">
		<span class="footerChild1">
		    <h6 class="SocialShare_socialShareTitle">Share this post</h6>
		    <ul class="SocialShare_socialIcons">
			<li>
			    <a title="Tweet" target="_blank" rel="noopener noreferrer" href="https://twitter.com/intent/tweet?text=Computing%20Symbolic%20Gradient%20Vectors%20with%20Plain%20Haskell&amp;url=https:&#x2F;&#x2F;blog.aloni.org&#x2F;posts&#x2F;symbolic-gradients-with-plain-haskell&#x2F; by @DanAloni"
				class="SocialShare_socialIconButton" style="--socialIconColor:var(--colorTwitter)">
				<svg xmlns="http://www.w3.org/2000/svg"
				    viewBox="0 0 512 512" class="twitter_svg__svg-inline--fa twitter_svg__fa-w-14"><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z">
				</path></svg>
			    </a>
			</li>
			<li><a title="Share on Linkedin" target="_blank" rel="noopener noreferrer" href="https://www.linkedin.com/sharing/share-offsite/?url=https:&#x2F;&#x2F;blog.aloni.org&#x2F;posts&#x2F;symbolic-gradients-with-plain-haskell&#x2F;" class="SocialShare_socialIconButton" style="--socialIconColor:var(--colorLinkedIn)">
				<svg aria-hidden="true" data-prefix="fab" data-icon="linkedin-in" class="linkedin_svg__svg-inline--fa linkedin_svg__fa-linkedin-in linkedin_svg__fa-w-14" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">
				    <path fill="currentColor" d="M100.28 448H7.4V148.9h92.88zM53.79 108.1C24.09 108.1 0 83.5 0 53.8a53.79 53.79 0 01107.58 0c0 29.7-24.1 54.3-53.79 54.3zM447.9 448h-92.68V302.4c0-34.7-.7-79.2-48.29-79.2-48.29 0-55.69 37.7-55.69 76.7V448h-92.78V148.9h89.08v40.8h1.3c12.4-23.5 42.69-48.3 87.88-48.3 94 0 111.28 61.9 111.28 142.3V448z">
				    </path>
				</svg></a>
			</li>
			<li id="aloni-copy-link">
			    <span tabindex="0" title="Copy post link" class="SocialShare_socialIconButton" style="--socialIconColor:var(--colorNeutral900)"><svg aria-hidden="true" data-prefix="far" data-icon="link" class="link_svg__svg-inline--fa link_svg__fa-link link_svg__fa-w-16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
				    <path fill="currentColor" d="M314.222 197.78c51.091 51.091 54.377 132.287 9.75 187.16-6.242 7.73-2.784 3.865-84.94 86.02-54.696 54.696-143.266 54.745-197.99 0-54.711-54.69-54.734-143.255 0-197.99 32.773-32.773 51.835-51.899 63.409-63.457 7.463-7.452 20.331-2.354 20.486 8.192a173.31 173.31 0 004.746 37.828c.966 4.029-.272 8.269-3.202 11.198L80.632 312.57c-32.755 32.775-32.887 85.892 0 118.8 32.775 32.755 85.892 32.887 118.8 0l75.19-75.2c32.718-32.725 32.777-86.013 0-118.79a83.722 83.722 0 00-22.814-16.229c-4.623-2.233-7.182-7.25-6.561-12.346 1.356-11.122 6.296-21.885 14.815-30.405l4.375-4.375c3.625-3.626 9.177-4.594 13.76-2.294 12.999 6.524 25.187 15.211 36.025 26.049zM470.958 41.04c-54.724-54.745-143.294-54.696-197.99 0-82.156 82.156-78.698 78.29-84.94 86.02-44.627 54.873-41.341 136.069 9.75 187.16 10.838 10.838 23.026 19.525 36.025 26.049 4.582 2.3 10.134 1.331 13.76-2.294l4.375-4.375c8.52-8.519 13.459-19.283 14.815-30.405.621-5.096-1.938-10.113-6.561-12.346a83.706 83.706 0 01-22.814-16.229c-32.777-32.777-32.718-86.065 0-118.79l75.19-75.2c32.908-32.887 86.025-32.755 118.8 0 32.887 32.908 32.755 86.025 0 118.8l-45.848 45.84c-2.93 2.929-4.168 7.169-3.202 11.198a173.31 173.31 0 014.746 37.828c.155 10.546 13.023 15.644 20.486 8.192 11.574-11.558 30.636-30.684 63.409-63.457 54.733-54.735 54.71-143.3-.001-197.991z">
				    </path>
				</svg>
			    </span>
			</li>
		    </ul>
		</span>
		
		<span class="footerChild2">
		    <h6 class="SocialShare_socialShareTitle">Follow author</h6>
		    <ul class="SocialShare_socialIcons">
			<li>
			    <a href="https://twitter.com/DanAloni?ref_src=twsrc%5Etfw" data-dnt="true" data-show-count="false" data-show-screen-name="false" class="SocialShare_socialIconButton twitter-follow-button" style="--socialIconColor:var(--colorTwitter)">
				<svg xmlns="http://www.w3.org/2000/svg"
				    viewBox="0 0 512 512" class="twitter_svg__svg-inline--fa twitter_svg__fa-w-14"><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z">
				</path></svg>
			    </a>
			    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
			</li>
		    </ul>
		</span>
		
	    </div>
	</div>
      </div>
    </div>
  </div>
</div>


  
    
<footer class="footer text-muted">
	<div class="container">
		<div class="row">
			<div class="col-lg-8 order-last order-lg-first">
				<ul class="list-inline">
					
						<li class="list-inline-item">Powered by a customized <a href="https://www.getzola.org/">Zola</a>, with a <a href="https://github.com/aaranxu/adidoks">AdiDoks</a> theme</li>
					
				</ul>
			</div>
			<div class="col-lg-8 order-first order-lg-last text-lg-end">
				<ul class="list-inline">
					
				</ul>
			</div>
		</div>
	</div>
</footer>

  

  
<script src="https://blog.aloni.org/js/main.js" defer></script>


</body>
</html>
